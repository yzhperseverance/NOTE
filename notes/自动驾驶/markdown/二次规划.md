# 二次规划

​	在SL规划中，本质上其实是想让l=f(s)尽可能平滑，因为l是横向的位移，他的平滑性就代表了整个路径的平滑性。

​	对于连接$l_i=f(s_i)$和$l_{i+1}=f(s_{i+1})$的曲线，在si处进行三阶泰勒展开，用来保证轨迹的连续性。

![image-20241130174353238](C:\Users\28609\AppData\Roaming\Typora\typora-user-images\image-20241130174353238.png)

​	那么整个的等式约束即为：

![image-20241130181137314](C:\Users\28609\AppData\Roaming\Typora\typora-user-images\image-20241130181137314.png)

​	对于凸空间范围的不等式约束，对车的四个角点进行约束，并做出近似，即使近似的不好也只代表θ值大，代表凸空间更小了，路径反而更安全，所以无所谓。

![image-20241130181531680](C:\Users\28609\AppData\Roaming\Typora\typora-user-images\image-20241130181531680.png)

​	具体的实施策略应在车前后一段距离内找到$l_{max}$和$l_{min}$，然后对角点做出约束。

![image-20241130181829153](C:\Users\28609\AppData\Roaming\Typora\typora-user-images\image-20241130181829153.png)

![image-20241130181839432](C:\Users\28609\AppData\Roaming\Typora\typora-user-images\image-20241130181839432.png)

![image-20241130181851939](C:\Users\28609\AppData\Roaming\Typora\typora-user-images\image-20241130181851939.png)

## 代价函数

![image-20241130182008598](C:\Users\28609\AppData\Roaming\Typora\typora-user-images\image-20241130182008598.png)

## 工程上的问题

一. **在靠近障碍物时，二次规划崩溃**

​	在约束中，需要加入初始位置约束，也就是限制轨迹的初始点，这个初始点一般是跟上一段轨迹拼接而来的（在控制不出问题的情况下），就是之前的Fem smooth。但这个初始点并不能保证是不碰撞的，因此如果车离障碍物很近，此时初始位置就可能落在障碍物里，导致整条路径碰撞。

​	本质原因也跟带硬约束的凸优化的最优解会靠近区域边界，导致轨迹离障碍物很近。解决方法有两种：

- 膨胀障碍物，规划起点不动
- 更改极小值点的位置，也就是更改代价函数中最后一项，更改方法有两种：

1. 仍用凸空间几何中心当作中央，增大权重。问题在于如果权重调大可能在无障碍物正常行驶的地方使路径不平滑，因为center line本来就不是平滑的；权重调小可能就没啥用了。可以通过在障碍物段和直线段分配不同的权重解决。

   优点是几何稳定。

   ![image-20241130183240947](C:\Users\28609\AppData\Roaming\Typora\typora-user-images\image-20241130183240947.png)

2. 用dp path的结果当作center line，优点是平滑，缺点是几何不稳定。

**二. 方向盘大幅摆动，车抖**

​	原因在于优化出的轨迹会离边界较近，而在凸空间的边界处可能会在“满足动力学约束”和“不满足动力学约束”之间反复横跳，可能上一帧满足，但走着走着就不满足了。

​	解决方法：加约束，这可能会使得解空间变小，求解困难。可以减少QP点的个数，规划完之后再插值加点。

![image-20241130184834317](C:\Users\28609\AppData\Roaming\Typora\typora-user-images\image-20241130184834317.png)

**三. dp的决策可能会一直变**

​	对已经做出决策的障碍物打标签，使用之前的决策。只对新遇到的障碍物使用dp决策。